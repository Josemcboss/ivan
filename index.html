
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Gran Flota SOUTHCOM - Simulación Total</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .label {
            position: absolute;
            color: #00ffcc;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 0 4px #000;
            background: rgba(0, 30, 15, 0.6);
            padding: 4px 8px;
            border: 1px solid #00ffcc;
            border-radius: 4px;
            transform: translate(-50%, -50%);
            white-space: nowrap;
        }
        .label.enemy { color: #ff3333; border-color: #ff3333; background: rgba(30, 0, 0, 0.6); }
        .label.air { color: #ffff33; border-color: #ffff33; }
        
        #info {
            position: absolute; top: 10px; width: 100%; text-align: center; color: white; pointer-events: none;
            text-shadow: 1px 1px 2px black; z-index: 10;
        }
        h1 { margin: 0; font-size: 1.1rem; letter-spacing: 1px; }
        p { font-size: 0.8rem; margin: 2px 0; opacity: 0.8; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.2rem;}
    </style>
</head>
<body>
    <div id="info">
        <h1>DESPLIEGUE TOTAL: SOUTHCOM & ASSETS</h1>
        <p>1 Dedo: Rotar | 2 Dedos: Mover y Zoom</p>
    </div>
    <div id="loading">Desplegando Flota...</div>
    <div id="ui-layer"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { Water } from 'three/addons/objects/Water.js';
        import { Sky } from 'three/addons/objects/Sky.js';

        let camera, scene, renderer, controls, water;
        const objectsToLabel = []; // Array para guardar objetos que tendrán etiquetas
        const uiLayer = document.getElementById('ui-layer');

        // Textura de agua
        const waterNormalsBase64 = 'data:image/jpg;base64,/2P/gABBKRklGAAEBAQBgAGAAAP/bAEMAAwICAwICAwMDAwQDAwQFCAUFBAQFCgcHBggMCgwMCwoLCw0OEhANDhEOCwsQFhAREhQUFBYMEhYYEhYYFhYWFP/bAEMBAwQEBQUFCgUFChQSChIUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFP/AABEIAIAAgAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AP18ooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA//Z';

        init();
        animate();

        function init() {
            // RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // SCENE & CAMERA
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 10, 30000);
            camera.position.set(0, 300, 600); // Cámara alta y lejos para ver todo

            // LUZ
            const sun = new THREE.Vector3();
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(100, 150, -100);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 4096;
            dirLight.shadow.mapSize.height = 4096;
            // Aumentar área de sombras para cubrir toda la flota
            dirLight.shadow.camera.left = -500; dirLight.shadow.camera.right = 500;
            dirLight.shadow.camera.top = 500; dirLight.shadow.camera.bottom = -500;
            scene.add(dirLight);

            // AGUA
            const waterGeo = new THREE.PlaneGeometry(30000, 30000);
            water = new Water(waterGeo, {
                textureWidth: 512, textureHeight: 512,
                waterNormals: new THREE.TextureLoader().load(waterNormalsBase64, t => {
                    t.wrapS = t.wrapT = THREE.RepeatWrapping;
                    document.getElementById('loading').style.display = 'none';
                }),
                sunDirection: new THREE.Vector3(),
                sunColor: 0xffffff,
                waterColor: 0x001e0f,
                distortionScale: 3.7
            });
            water.rotation.x = -Math.PI / 2;
            scene.add(water);

            // CIELO
            const sky = new Sky();
            sky.scale.setScalar(30000);
            scene.add(sky);
            const sunParams = { elevation: 2, azimuth: 180 };
            const theta = Math.PI * (sunParams.elevation / 180 - 0.5);
            const phi = 2 * Math.PI * (sunParams.azimuth / 180 - 0.5);
            sun.x = Math.cos(phi); sun.y = Math.sin(phi) * Math.sin(theta); sun.z = Math.sin(phi) * Math.cos(theta);
            sky.material.uniforms['sunPosition'].value.copy(sun);
            water.material.uniforms['sunDirection'].value.copy(sun).normalize();
            dirLight.position.copy(sun).multiplyScalar(1000);

            // CONTROLES
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enablePan = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;
            controls.minDistance = 50;
            controls.maxDistance = 2000;

            // --- MATERIALES ---
            const greyMat = new THREE.MeshStandardMaterial({ color: 0x606060, roughness: 0.6 });
            const darkMat = new THREE.MeshStandardMaterial({ color: 0x303030, roughness: 0.8 });
            const redMat = new THREE.MeshStandardMaterial({ color: 0x8a2be2, roughness: 0.5 }); // Color "Target" (Dark Fleet)

            // --- CONSTRUCTORES DE NAVES ---

            // 1. CVN (Gerald R Ford)
            function createCVN() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.BoxGeometry(50, 15, 220), greyMat);
                hull.position.y = 6; hull.castShadow = true; g.add(hull);
                // Cubierta ancha
                const deckShape = new THREE.Shape();
                deckShape.moveTo(-40, -115); deckShape.lineTo(40, -115); deckShape.lineTo(40, 90); deckShape.lineTo(60, 115); deckShape.lineTo(-50, 115);
                const deck = new THREE.Mesh(new THREE.ExtrudeGeometry(deckShape, {depth: 2, bevelEnabled:false}), darkMat);
                deck.rotation.x = Math.PI/2; deck.position.y = 14; deck.receiveShadow = true; g.add(deck);
                // Isla
                const tower = new THREE.Mesh(new THREE.BoxGeometry(10, 15, 20), greyMat);
                tower.position.set(30, 22, 50); tower.castShadow = true; g.add(tower);
                return g;
            }

            // 2. LHD (Iwo Jima - Amphibious)
            function createLHD() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.BoxGeometry(35, 14, 180), greyMat);
                hull.position.y = 5; hull.castShadow = true; g.add(hull);
                const deck = new THREE.Mesh(new THREE.BoxGeometry(50, 1, 190), darkMat);
                deck.position.y = 12.5; deck.receiveShadow = true; g.add(deck);
                const tower = new THREE.Mesh(new THREE.BoxGeometry(8, 12, 30), greyMat);
                tower.position.set(18, 19, 20); g.add(tower);
                return g;
            }

            // 3. LPD (San Antonio)
            function createLPD() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.BoxGeometry(25, 10, 140), greyMat);
                hull.position.y = 4; hull.castShadow = true; g.add(hull);
                // Estructura poligonal del San Antonio (mástiles cerrados)
                const superStr = new THREE.Mesh(new THREE.CylinderGeometry(0, 10, 25, 4), greyMat);
                superStr.position.set(0, 12, -20); superStr.rotation.y = Math.PI/4; g.add(superStr);
                const helipad = new THREE.Mesh(new THREE.BoxGeometry(24, 1, 40), darkMat);
                helipad.position.set(0, 9.5, 45); g.add(helipad);
                return g;
            }

            // 4. DDG/CG (Destructores)
            function createDDG() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.BoxGeometry(10, 7, 70), greyMat);
                hull.position.y = 3.5; g.add(hull);
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(8, 8, 18), greyMat);
                bridge.position.set(0, 8, 5); g.add(bridge);
                return g;
            }

            // 5. Submarino
            function createSub() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.CylinderGeometry(4, 4, 80), darkMat);
                hull.rotation.z = Math.PI/2; hull.position.y = 0; g.add(hull);
                const sail = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 10), darkMat);
                sail.position.set(0, 5, -10); g.add(sail);
                return g;
            }

            // 6. Tanker (Objetivo)
            function createTanker() {
                const g = new THREE.Group();
                const hull = new THREE.Mesh(new THREE.BoxGeometry(30, 12, 160), new THREE.MeshStandardMaterial({color: 0x883333}));
                hull.position.y = 5; g.add(hull);
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(25, 15, 15), new THREE.MeshStandardMaterial({color: 0xffffff}));
                bridge.position.set(0, 15, 65); g.add(bridge);
                return g;
            }

            // 7. Aviones (F-35 y B-52)
            function createJet(type) {
                const g = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({color: 0x444444});
                if(type === 'F35') {
                    g.add(new THREE.Mesh(new THREE.ConeGeometry(1, 6, 4), mat)); // Cuerpo
                    const w = new THREE.Mesh(new THREE.BoxGeometry(5, 0.2, 2), mat); w.position.z = 1; g.add(w);
                    g.rotation.x = Math.PI/2;
                } else if (type === 'B52') {
                    // Cuerpo largo
                    const body = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 12), mat);
                    body.rotation.x = Math.PI/2; g.add(body);
                    // Alas enormes
                    const wings = new THREE.Mesh(new THREE.BoxGeometry(18, 0.2, 4), mat);
                    wings.position.z = 0; g.add(wings);
                    // Motores
                    const engine = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 1), mat);
                    engine.position.set(5, -1, 1); g.add(engine.clone());
                    engine.position.set(-5, -1, 1); g.add(engine);
                }
                return g;
            }


            // --- CONSTRUCCIÓN DEL ESCENARIO ---

            // Grupo 1: Carrier Strike Group (Centro)
            const csg = new THREE.Group();
            csg.position.set(0, 0, 0);
            const cvn = createCVN(); csg.add(cvn);
            addLabel(cvn, "USS GERALD R. FORD (CVN 78)");
            
            // Escoltas CVN
            const ddg1 = createDDG(); ddg1.position.set(-80, 0, -50); csg.add(ddg1);
            const ddg2 = createDDG(); ddg2.position.set(80, 0, -50); csg.add(ddg2);
            const cg = createDDG(); cg.scale.set(1.2,1.2,1.2); cg.position.set(0, 0, 150); csg.add(cg); // Cruiser
            addLabel(cg, "USS NORMANDY (CG 60)");
            scene.add(csg);

            // Grupo 2: Amphibious Ready Group (Izquierda)
            const arg = new THREE.Group();
            arg.position.set(-300, 0, 100);
            const lhd = createLHD(); arg.add(lhd);
            addLabel(lhd, "USS IWO JIMA (LHD 7)");
            
            const lpd1 = createLPD(); lpd1.position.set(-60, 0, 100); arg.add(lpd1);
            const lpd2 = createLPD(); lpd2.position.set(60, 0, 100); arg.add(lpd2);
            addLabel(lpd1, "USS SAN ANTONIO");
            scene.add(arg);

            // Grupo 3: Surface Action Group / Tomahawk Shooters (Derecha)
            const sag = new THREE.Group();
            sag.position.set(300, 0, 50);
            for(let i=0; i<4; i++) {
                const d = createDDG();
                d.position.set((i-1.5)*50, 0, (i%2)*60);
                sag.add(d);
            }
            addLabel(sag, "TLAM STRIKE PACKAGE (Destroyers)");
            scene.add(sag);

            // Grupo 4: Submarinos (Avanzada)
            const sub1 = createSub(); sub1.position.set(-100, -2, -200); scene.add(sub1);
            const sub2 = createSub(); sub2.position.set(100, -2, -200); scene.add(sub2);
            addLabel(sub1, "SSN (Attack Sub)");

            // Grupo 5: Dark Fleet Targets (Muy lejos al fondo)
            const targets = new THREE.Group();
            targets.position.set(0, 0, -800);
            const t1 = createTanker(); t1.position.x = -100; targets.add(t1);
            const t2 = createTanker(); t2.position.x = 0; targets.add(t2);
            const t3 = createTanker(); t3.position.x = 100; targets.add(t3);
            addLabel(t2, "TARGETS: DARK FLEET TANKERS", "enemy");
            scene.add(targets);

            // Grupo 6: Aéreos
            // F-35 Wing
            const f35Group = new THREE.Group();
            for(let i=0; i<5; i++) {
                const jet = createJet('F35');
                jet.position.set((i-2)*20, 0, (Math.abs(i-2)*-10));
                f35Group.add(jet);
            }
            f35Group.position.set(0, 150, 0);
            scene.add(f35Group);
            addLabel(f35Group, "VTANG F-35A SQUAD", "air");

            // Bomber Wing (B-52s/B-1s) - Más alto y atrás
            const bomberGroup = new THREE.Group();
            const b1 = createJet('B52'); b1.position.x = -40; bomberGroup.add(b1);
            const b2 = createJet('B52'); b2.position.x = 40; bomberGroup.add(b2);
            bomberGroup.position.set(0, 400, 300); // Muy alto
            scene.add(bomberGroup);
            addLabel(bomberGroup, "BOMBER STRIKE PACKAGE", "air");


            // Loop animación
            window.addEventListener('resize', onWindowResize);
            
            function animateLoop() {
                requestAnimationFrame(animateLoop);
                const time = performance.now() * 0.001;
                
                water.material.uniforms['time'].value += 1.0 / 60.0;
                
                // Mover aviones
                f35Group.position.z = Math.sin(time * 0.2) * 300;
                f35Group.rotation.y = Math.sin(time * 0.1) * 0.5;

                bomberGroup.position.z -= 0.5; // Bombarderos avanzan lento
                if(bomberGroup.position.z < -1000) bomberGroup.position.z = 1000;

                updateLabels();
                controls.update();
                renderer.render(scene, camera);
            }
            animateLoop();
        }

        function addLabel(obj, text, type="normal") {
            const div = document.createElement('div');
            div.className = 'label ' + type;
            div.textContent = text;
            uiLayer.appendChild(div);
            objectsToLabel.push({ element: div, object: obj });
        }

        function updateLabels() {
            objectsToLabel.forEach(item => {
                const pos = item.object.position.clone();
                // Si es un grupo, obtener posición global es más seguro
                item.object.getWorldPosition(pos);
                pos.y += 20; // Flotar sobre el objeto

                pos.project(camera); // Convertir a 2D

                // Solo mostrar si está frente a la cámara
                if (Math.abs(pos.z) < 1) {
                    const x = (pos.x * .5 + .5) * window.innerWidth;
                    const y = (-(pos.y * .5) + .5) * window.innerHeight;
                    item.element.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                    item.element.style.display = 'block';
                } else {
                    item.element.style.display = 'none';
                }
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
